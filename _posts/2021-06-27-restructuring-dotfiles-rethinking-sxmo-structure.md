---
layout: post
title:  "a sxmo inspired rethinking of my dotfiles and also a proof of concept for a new structuring of sxmo-utils"
---

# WIP!

#### Introduction
After sieving through the sxmo-utils, i started thinking about the structure of sxmo and how the scripts are executed and loaded, which lead me into a journey of rethinking my own dotfiles, i'll talk about that in detail in this blogpost. i've rewritten the filepaths and -names to fit in the context of sxmo.

## abstract
why? customizing, uncluttering, reusability and easily overwrite functions in you own configs


## /etc/profiles.d/ and the .profile
to have systemwide access to the functions i decided to go for /etc/profile.d/. when you put a script in there it gets source on login, but only once, so if you change anything there you have to relogin.
```sh
-> % cat /etc/profile.d/sxmo.sh
#!/usr/bin/env sh
. /usr/share/sxmo/.profile
```
## so our functions are sourced via .profile everything should just work, right? no!
a problem i immediatly encountered is that the .profile isnt sourced in a non-interactive shell.
which means, running following commands won't work without sourcing the profile again, as seen below.
also programs like dmenu, sxkhdm, xinit and so on, can't run those functions nicely without sourcing the .profile.
to illustrate this point better and also for debugging i introduced the [hello]() function.

```sh
-> % which hello
hello () {
        echo "hello world! you are running a"
        case $- in
                (*i*) echo "interactive" ;;
                (*) echo "non-interactive" ;;
        esac
        tty | grep -q "tty" && echo "tty / (?)login shell" || echo "non-login shell"
}

-> % hello
hello world! you are running a
interactive
non-login shell

-> % sh -c hello
sh: row 1: hello: command not found

-> % sh -c ". $DOTFILES/.functions; hello"
hello world! you are running a
non-interactive
non-login shell

-> % sh -ic "hello"
hello world! you are running a
interactive
non-login shell
```
as you see in the example above `sh -c hello` throws a command not found error, because it is a non-interactive shell.
the command only works when you source the `.functions` again before running the command `sh -c ". $DOTFILES/.functions; hello"`.
similar `sh -ic hello` runs as expected because -i forces interactive shell. this is a problem because in some cases like .xinitrc, dmenu, sxhkd and probably many more, it is not clean to force an interactive shell or source our `.functions` again in each of these cases, so our function will fail.

i dont like sourcing files over and over again, so i came up with, what i think is, a rather clever solution.
first of all i created a bin directory in /usr/share/sxmo which i put into the $PATH in `.profile` so binaries there are found.
binaries can be executed also in a non-interactive context and with this magical
[run_function](https://github.com/dni/dotfiles/blob/sxmo/scripts/run_function) script and symlinks to it, it is
possible to simply run any of our defined functions in a non-interactive way and sourcing is done inside the run_function.

now after running [create_binaries]() function the symlinks in our bin directory are regenerated and after sourcing our non working command now runs just fine everywhere, everytime, hopefully :).

```sh
-> % sh -c hello
hello world! you are running a
non-interactive
non-login shell
```


#### run_script
```sh
#!/usr/bin/env sh

# this file is useful for running functions in a non-interactive shell
# (dmenu, xinit, sxhkd). so we need to source our functions here and
# run them, else we end in an infinite loop. functions are not sourced
# in a non-interactive shell so we create symlinks to this script
# in the $PATH and source the profile.

# TODO: not sure if this also works yet need to investigate more
# run interactive shell, so .profile is sourced already
# sh -ic "${0##*/}"

# source .profile with functions and eval
# symlinked binaries in the $PATH are overwritten by the function calls
. "$DOTFILES"/.profile
eval "${0##*/}"
```

the symlinks are regenerated by calling the function [create_binaries](https://github.com/dni/dotfiles/blob/sxmo/scripts/utils.sh#L18)
```sh
# populate ./bin/ with symlink to the magic run_function script
create_binaries() {
  rm "$DOTFILES"/bin/*
  get_functions | while read -r x; do
    ln -sf "$DOTFILES"/scripts/run_function "$DOTFILES"/bin/"$x"
  done
}
```



# Links

* [dotfiles](https://github.com/dni/dotfiles/tree/sxmo)
* [run_function](https://github.com/dni/dotfiles/blob/sxmo/scripts/run_function)
* IRC: #sxmo on irc.oftc.net
