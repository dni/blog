I"þ<hr />

<h1 id="after-many-tries-and-failures-i-finally-did-it">after many tries and failures, i finally did it</h1>

<p>i recently stumpled upon this very nice <a href="https://github.com/LukeSmithxyz/emailwiz">emailwiz</a> script from LukeSmithxyz on github. Inspired by that, i gave setting up my own mailserver another try. It was surprisingly simple, it is running for weeks now and i had no troubles so far.</p>

<hr />

<h1 id="modification">modification</h1>
<p>i modified the script a little bit more included the certbot stuff and patched some stuff i found on the github issues pages.
Github link: <a href="https://github.com/dni/scripts/blob/main/server/install-email.sh">install-email</a>
neue version</p>

<hr />

<h1 id="multiple-mailboxes-and-domains">multiple mailboxes and domains</h1>
<p>for this i had browse the web a little while and found this 2 useful resources <a href="http://www.postfix.org/VIRTUAL_README.html">postfix virtual</a>
and <a href="https://www.linuxbabe.com/redhat/host-multiple-mail-domains-in-postfixadmin-centos-rhel">linuxbabe</a>.</p>

<ol>
  <li>you have to add a new unix user for each mailbox
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> useradd -m -G mail newaccount
 passwd newaccount
</code></pre></div>    </div>
  </li>
  <li>expand the ssl certificate, you need to have the A and CNAME dns record working for the SSL certificate, see 5.
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>certbot certonly --webroot --agree-tos --text --non-interactive --webroot-path /var/www/html -d mail.domain1.com,mail.domain2.org --expand
</code></pre></div>    </div>
  </li>
  <li>generate the dkim keys and edit <code class="language-plaintext highlighter-rouge">signingtable</code>, <code class="language-plaintext highlighter-rouge">keytable</code> and <code class="language-plaintext highlighter-rouge">trustedhosts</code>.
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>opendkim-genkey -b 2048 -d domain2.org -D /etc/postfix/dkim/ -s mail-domain2 -v
chown opendkim:opendkim mail-domain2.private
echo "mail-domain2._domainkey.domain2.org domain2.org:mail-domain2:/etc/postfix/dkim/mail-domain2.private" &gt;&gt; /etc/postfix/dkim/keytable
echo "*.domain2.org" &gt;&gt; /etc/postfix/dkim/trustedhosts
echo "*@domain2.org mail-domain2._domainkey.domain2.org" &gt;&gt; /etc/postfix/dkim/signingtable
</code></pre></div>    </div>
  </li>
  <li>edit the file <code class="language-plaintext highlighter-rouge">/etc/postfix/virtual</code>.
for first time using more than 1 accounts you also need to configure postfix <code class="language-plaintext highlighter-rouge">main.cf</code> and add a file <code class="language-plaintext highlighter-rouge">virtual</code>.
important! do not add you main domain <code class="language-plaintext highlighter-rouge">domain1.com</code> to your <code class="language-plaintext highlighter-rouge">virtual_alias_domains</code>.
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>postconf -e "virtual_alias_domains = domain2.org"
postconf -e "virtual_alias_maps = hash:/etc/postfix/virtual"
cat &lt;&lt;EOF
postmaster@domain1.com   postmaster
office@domain1.com       oldaccount
admin@domain1.com        oldaccount
postmaster@domain2.org   postmaster
info@domain2.org         newaccount
EOF &gt; /etc/postfix/virtual
</code></pre></div>    </div>
    <hr />
  </li>
  <li>add all the required dns record. reverse dns is not needed multiple times it is fine if your main domain works.
note: replace <code class="language-plaintext highlighter-rouge">127.0.0.1</code> with your ip address.
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>A     domain2.org        "127.0.0.1"
A     mail.domain2.org   "127.0.0.1"
MX    domain2.org        "10 mail.domain2.org"
TXT   domain2.org        "v=spf1 mx a:mail.domain2.org -all"
TXT   _dmarc.domain2.org "v=DMARC1; p=reject; rua=mailto:dmarc@domain2.org; fo=1"
</code></pre></div>    </div>
    <p>the domainkey TXT record you can <code class="language-plaintext highlighter-rouge">cat /etc/postfix/dkim/mail-domain2.txt</code>. i shortened the rsa key, but it should look something like that:</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>TXT mail-domain2._domainkey.domain2.org "v=DKIM1; h=sha256; k=rsa; \""
"p=MIIBIjANBgkqhkiG9WbcWfa2FgonIQH/HHEpK5nFF5yJ"
"X2McsrH0Bm4JvekHgUVQlpboNCCP2+m1UlFQML4wIDAQAB"
</code></pre></div>    </div>
    <hr />
  </li>
</ol>

<h1 id="mail-client---mutt">mail client - mutt</h1>
<p>i also use mutt for mail and i found this very nice <a href="https://github.com/LukeSmithxyz/mutt-wizard">mutt-wizard</a> script
also from LukeSmithxyz, for setting up the addresses. it is very well documented.
you need to install <code class="language-plaintext highlighter-rouge">neomutt</code> for this to work properly.</p>

<hr />

<h1 id="links">links</h1>

<ul>
  <li><a href="https://github.com/LukeSmithxyz/emailwiz">emailwiz</a></li>
  <li><a href="https://github.com/dni/scripts/blob/main/server/install-email.sh">install-email</a></li>
  <li><a href="http://www.postfix.org/VIRTUAL_README.html">postfix virtual</a></li>
  <li><a href="https://www.linuxbabe.com/redhat/host-multiple-mail-domains-in-postfixadmin-centos-rhel">linuxbabe</a></li>
  <li><a href="https://github.com/LukeSmithxyz/mutt-wizard">mutt-wizard</a></li>
</ul>
:ET